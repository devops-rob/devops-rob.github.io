<!doctype html><html><head><title>Architecting Vault - Part 1</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600"><link rel=stylesheet href=/fontawesome/css/all.min.css><meta property="og:title" content="Architecting Vault - Part 1"><meta property="og:description" content="Part 1 in a blog series exploring architectural the design decisions of a Vault architect"><meta property="og:type" content="article"><meta property="og:url" content="https://devops-rob.github.io/posts/vault/architecting-vault-part-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-14T08:06:25+06:00"><meta property="article:modified_time" content="2019-07-14T08:06:25+06:00"><meta name=description content="Part 1 in a blog series exploring architectural the design decisions of a Vault architect"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>DevOps Rob</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/posts/conference-talks/>Conference Talks</a><ul><li><a href=/posts/conference-talks/devops-exchange-london-march-2022/ title="DevOps Exchange London March 2022">DevOps Exchange London March 2022</a></li><li><a href=/posts/conference-talks/hashiconf-eu-2021/ title="HashiConf EU 2021: The Zero Trust Mindset">HashiConf EU 2021: The Zero Trust Mindset</a></li><li><a href=/posts/conference-talks/hashitalks-2020/ title="HashiTalks 2020: Securing RabbitMQ with Vault">HashiTalks 2020: Securing RabbitMQ with Vault</a></li><li><a href=/posts/conference-talks/kafka-summit-eu-2021/ title="Kafka Summit EU 2021: Encrypting Kafka messages at rest to secure applications">Kafka Summit EU 2021: Encrypting Kafka messages at rest to secure applications</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/devops/>DevOps</a><ul><li><a href=/posts/devops/what-is-the-future-of-devops/ title="What is the future of DevOps">What is the future of DevOps</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/vault/>HashiCorp Vault</a><ul class=active><li><a class=active href=/posts/vault/architecting-vault-part-1/ title="Architecting Vault - Part 1">Architecting Vault - Part 1</a></li><li><a href=/posts/vault/architecting-vault-part-2/ title="Architecting Vault - Part 2">Architecting Vault - Part 2</a></li><li><a href=/posts/vault/architecting-vault-part-3/ title="Architecting Vault - Part 3">Architecting Vault - Part 3</a></li><li><a href=/posts/vault/architecting-vault-part-4/ title="Architecting Vault - Part 4">Architecting Vault - Part 4</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/the-devops-lab-videos/>The DevOps Lab (Channel9)</a><ul><li><a href=/posts/the-devops-lab-videos/part1-automating-secrets-management/ title="Automating Secrets Management - Part 1">Automating Secrets Management - Part 1</a></li><li><a href=/posts/the-devops-lab-videos/part2-automating-secrets-management/ title="Automating Secrets Management - Part 2">Automating Secrets Management - Part 2</a></li><li><a href=/posts/the-devops-lab-videos/workload-authentication/ title="Workload authentication">Workload authentication</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://devops-rob.github.io/images/vault/part1-hero.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/authors/hashiconf_huebbfad1edfa8e198fe68a27ac6a615ca_208200_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Rob Barnes</h5><p>Sunday, July 14, 2019</p></div><div class=title><h1>Architecting Vault - Part 1</h1></div><div class=post-content id=post-content><p>In the modern world, applications and the infrastructure they run on are moving to a multi-cloud, multi-platform and multi-service approach. This means that applications are being separated into service components that make up an application stack and run on a number of different platforms to deliver the business value, for example, some services may run in a container which is orchestrated by Kubernetes or Nomad, some may be run on Virtual Machines and the others run as Serverless functions using services like Lambda or FunctionApp. These services, whichever platform they are being run on, can be run either on-premise and/or in one or more of the biggest cloud providers (GCP, AWS, Azure, Alicloud) to create a multi-cloud hosted application.</p><p>The shift to this approach requires a change in mindset on many different fronts, especially security and secrets management as the networks that these applications use, move from a trusted network approach to a trustless network approach. In a trusted Network, credentials and secrets which allow application services to talk to one another are typically stored in the application code or in a configuration map as there is 100% control over the network and and it&rsquo;s perimeter, meaning all services and users inside the perimeter can be trusted. There are flaws in this approach but it was and still is a common practice for many organisations. Moving to a cloud approach means loosing some of that control over the network perimeters as the cloud providers are partially responsible for network security under the Shared Responsibility Model.</p><p>This breeds the introduction a different paradigm in Trustless Network approach as we can no longer have the same perimeters in place and can no longer trust the perimeters that are not completely under our control. In this new approach, secrets can no longer be stored in the same way using config maps or hardcoded in the application code, which presents a new challenge for application developers and DevOps engineers who are developing, deploying and running these applications and infrastructure at scale.
HashiCorp Vault is a secure secrets management platform which solves this problem, along with other problems we face in modern day application engineering including:</p><ol><li>Encryption as a service</li><li>Key management</li></ol><p>When architecting your vault deployment, there are some fundamental questions you need to answer before designing your cluster. This series of Architecting Vault blogs will address these questions in more detail and explore ways to find the most suitable solution for individual use-cases.
What platform do I host my vault cluster on?
The first decision we need to make is what platform to use to host a Production Vault cluster. The most appropriate decision will differ from one organisation to the next and will depend on their current cloud strategy (if they have one), their industry compliance requirements, and the business value of the secrets that will be stored in the Vault cluster.
In addressing this question, let&rsquo;s look at what options there are to host Vault and common hosting platforms in use today, from on-premise data centres to cloud providers.
Containers
Deploying Vault into a container is a useful option for local development as you can spin up local instances quickly and reliably; however, the very nature of how containers work make it the most risky platform to deploy a Production Vault cluster on. Containers are virtual workloads which share the kernel, libraries and binaries of the underlying host operating system, which is what makes them so lightweight and an attractive option to run micro-service architecture applications at scale.
The things that make Containers such an attractive option for many services are also the very things that make Containers the least secure option for running Vault clusters. The shared kernel, binaries and libraries presents a larger attack surface for the Vault cluster and exposes it to any vulnerabilities in the container run time which can be exploited by malicious attackers.
This increased attack surface is an acceptable risk to some organisations as the secrets stored in the Vault clusters are not deemed to be business critical and so this may still be a viable deployment option for many organisations. If using a container orchestration platform like Kubernetes, you will need to be aware that the more tenants (services) you have running in your Kubernetes cluster, the more risks there are to access your organisations secrets held in Vault clusters hosted on the same Kubernetes clusters as other tenants.
I reached out to HashiCorp for their advice on running Vault in Kubernetes and Co-founder & CTO Mitchell Hashimoto responded with the following.</p><p>I attended the HashiConf EU conference in Amsterdam last week and took the opportunity to speak to many of the HashiCorp Vault Software Engineers about this dilemma of running Vault on a Kubernetes cluster. The underlying message I got is that HashiCorp do not recommend running Vault in Production inside containers; however, they do recognise that some organisations will accept the increased risk and will deploy into Kubernetes, which is the reason they are currently working on Helm Charts to help these organisations deploy Vault into Kubernetes clusters quickly and reliably.</p><h3 id=virtual-machines>Virtual Machines</h3><p>Running Vault Clusters on virtual machines is the most secure way to host Vault in Cloud environments. The underlying technology that enables virtual machines to work is different to the underlying technology that enables containerisation and has a smaller attack surface. Virtual machines are run on Hypervisors, which is a technology that allows physical resources such as Storage disks, CPU cores, Memory and Network Interface Cards (NICs) to be accessed and consumed by virtual machines. Hypervisors typically sit on top of an operating system, much like KVM sits on top of Linux Operating systems and Hyper-V sits on top of Windows operating systems. These Operating Systems are installed on bare metal servers.</p><p>The reason that this a more secure way to run Vault in production than containers is the fact that each virtual machine has its own operating system installed on it, which each have their own kernel, libraries and binaries. The image below depicts the difference between container technologies and Hypervisor technologies.</p><p><img src=images/virtual-vs-containerised.png alt=container-vs-vms></p><h3 id=bare-metal>Bare Metal</h3><p>For organisations that still have on-premise data centres hosting physical servers, running your production vault clusters on bare metal may be an option for them. The bare metal option is the most secure way of running Vault clusters in production as the hardware doesn&rsquo;t share itself with any other tenants. It provides you with complete control of the operating system and the underlying hardware.
This option does come with the most upfront cost to implement as you will need to procure dedicated server hardware for this deployment and will require physical resources to rack & stack the required hardware in the data centre and configure the networking accordingly. This option is most commonly used by financial organisations who&rsquo;s secrets are business critical and need the minimum attack surface exposure for compliance reasons as their systems hold financial data that underpins their very existence and in some cases the national / international economy.</p><h3 id=making-a-decision>Making a decision</h3><p>When making a decision as to how to host and run your Vault production clusters, I want to emphasise the fact that architectural design in general is a business driven exercise and should always exist to serve the purpose of achieving the business goals. There are some questions to which you need to seek answers for to help make the right decisions.</p><ol><li><p>What is the cloud strategy of the organisation - If your organisation has a cloud strategy, you should understand what the long term goals are for this strategy, for example, if currently there is a mix of on-premise and cloud work loads, is the aim to migrate everything to the cloud and retire the data centre? In this example, bare metal is probably not the most appropriate option to align to your business goals.</p></li><li><p>What is the value of the secrets to the organisation - The answer to this question is key and can often dictate whether your Vault cluster should be hosted and run on premise or in the cloud. The example mentioned earlier with secrets unlocking access to financial data would more often than not, influence the decision to use Bare metal installations.</p></li><li><p>Budget constraints - If cost of running and time to value is of the upmost importance then you may consider using VMs to get you up and running quickly but if in the cloud, these VMs will increase your cloud costs and still impact any budget constraints. If you are already running Kubernetes clusters in the cloud, running Vault clusters in containers is probably the most cost effective solution; however, it comes with the security trade-off mentioned earlier. Bare metal installations will take the longest amount of time to deploy as you will need to undertake a procurement exercise and hardware installation tasks before you can start configuring your Vault instances and this can take many weeks or in some cases months.</p></li></ol><p>Somewhere between the answers to these three questions will be the answer to your main question which is, what platform do I host my vault cluster on?</p><p>To conclude this chapter, I will leave you with a quote from the Vault Production Hardening guide for you to ponder.</p><p>&ldquo;Similarly, running on bare metal should be preferred to a VM, and a VM preferred to a container. This reduces the surface area introduced by additional layers of abstraction and other tenants of the hardware.&rdquo;</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/devops-rob/devops-rob.github.io/edit/main/content/posts/vault/architecting-vault-part-1.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/devops/what-is-the-future-of-devops/ title="What is the future of DevOps" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>What is the future of DevOps</div></a></div><div class="col-md-6 next-article"><a href=/posts/vault/architecting-vault-part-2/ title="Architecting Vault - Part 2" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Architecting Vault - Part 2</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#virtual-machines>Virtual Machines</a></li><li><a href=#bare-metal>Bare Metal</a></li><li><a href=#making-a-decision>Making a decision</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://devops-rob.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://devops-rob.github.io#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://devops-rob.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:iam@devopsrob.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>iam@devopsrob.com</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4></a></div><div class="col-md-4 text-center">© 2022 Copyright.</div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>